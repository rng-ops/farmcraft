name: AI-Controlled Tests with Attestation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Specific scenario to run (or "all")'
        required: false
        type: string
        default: 'all'

permissions:
  contents: read
  actions: write

env:
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  # Build and create attestations
  build-with-attestation:
    name: Build with Cryptographic Attestation
    runs-on: ubuntu-latest
    outputs:
      mod-hash: ${{ steps.hash-mod.outputs.sha256 }}
      packages-hash: ${{ steps.hash-packages.outputs.sha256 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Build TypeScript packages
        run: pnpm run build

      - name: Build Forge mod
        working-directory: mod/forge
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon

      - name: Generate build attestation
        run: |
          mkdir -p build-attestations

          # Create build manifest
          cat > build-attestations/build-manifest.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "actor": "${{ github.actor }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "workflow": "${{ github.workflow }}",
            "repository": "${{ github.repository }}"
          }
          EOF

      - name: Hash mod artifact
        id: hash-mod
        run: |
          MOD_JAR=$(find mod/forge/build/libs -name "*.jar" ! -name "*-sources.jar" -type f | head -1)
          if [ -f "$MOD_JAR" ]; then
            SHA256=$(sha256sum "$MOD_JAR" | awk '{print $1}')
            echo "sha256=$SHA256" >> $GITHUB_OUTPUT
            echo "MOD_SHA256=$SHA256" >> build-attestations/build-manifest.json
            echo "âœ… Mod hash: $SHA256"
          fi

      - name: Hash TypeScript packages
        id: hash-packages
        run: |
          find packages/*/dist server/*/dist -type f -name "*.js" | sort | xargs sha256sum > packages.sha256
          PACKAGES_HASH=$(sha256sum packages.sha256 | awk '{print $1}')
          echo "sha256=$PACKAGES_HASH" >> $GITHUB_OUTPUT
          echo "PACKAGES_SHA256=$PACKAGES_HASH" >> build-attestations/build-manifest.json
          echo "âœ… Packages hash: $PACKAGES_HASH"

      - name: Sign attestation
        run: |
          cd build-attestations
          ATTESTATION_HASH=$(sha256sum build-manifest.json | awk '{print $1}')
          echo "{\"attestation_hash\": \"$ATTESTATION_HASH\"}" > attestation-signature.json
          echo "ðŸ” Attestation signature: $ATTESTATION_HASH"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: farmcraft-build-${{ github.run_number }}
          path: |
            mod/forge/build/libs/*.jar
            server/*/dist/
            packages/*/dist/
            build-attestations/
          retention-days: 90

      - name: Upload attestations
        uses: actions/upload-artifact@v4
        with:
          name: build-attestations-${{ github.run_number }}
          path: build-attestations/
          retention-days: 365

  # Run AI-controlled tests on self-hosted M2 runner
  ai-controlled-tests-macos:
    name: AI Tests with Video & Packet Capture (macOS M2)
    runs-on: [self-hosted, macOS, ARM64, minecraft]
    needs: build-with-attestation
    timeout-minutes: 45
    if: ${{ !cancelled() }}

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: farmcraft-build-${{ github.run_number }}
          path: artifacts/

      - name: Setup test environment
        run: |
          echo "Setting up AI test environment..."
          mkdir -p ~/minecraft-ai-tests

          # Setup output directories
          mkdir -p ~/minecraft-ai-tests/{videos,packets,attestations,transcripts}

          # Copy built artifacts
          cp artifacts/mod/forge/build/libs/*.jar ~/minecraft-test-env/mods/ 2>/dev/null || true

      - name: Install dependencies
        run: |
          pnpm install --prefer-offline
          pnpm run build

      - name: Start FarmCraft servers
        run: |
          echo "Starting Recipe Server..."
          cd server/recipe-server
          pnpm start &
          echo "RECIPE_PID=$!" >> $GITHUB_ENV

          echo "Starting LLM Docs Server (GPT-OSS)..."
          cd ../../packages/llm-docs
          PORT=7424 OLLAMA_MODEL=gpt-oss pnpm start &
          echo "LLM_PID=$!" >> $GITHUB_ENV

          # Wait for servers
          sleep 15
          curl -f http://localhost:7420/health || echo "Recipe server not ready"
          curl -f http://localhost:7424/health || echo "LLM server not ready"

      - name: Start video recording
        run: |
          echo "Starting headless video recording..."
          HEADLESS=true DURATION=2400 \
            ~/record-minecraft-test.sh ~/minecraft-ai-tests/videos &
          echo "RECORDER_PID=$!" >> $GITHUB_ENV
          sleep 3

      - name: Start system profiling
        run: |
          echo "Starting system profiling..."
          ~/profile-minecraft-test.sh ~/minecraft-ai-tests/profiles &
          echo "PROFILER_PID=$!" >> $GITHUB_ENV
          sleep 2

      - name: Start Minecraft server
        run: |
          echo "Starting Minecraft server with FarmCraft mod..."
          cd mod/forge

          # Start server in background
          ./gradlew runServer --no-daemon > ~/minecraft-ai-tests/server.log 2>&1 &
          echo "MC_SERVER_PID=$!" >> $GITHUB_ENV

          # Wait for server to be ready
          echo "Waiting for Minecraft server..."
          for i in {1..120}; do
            if grep -q "Done" ~/minecraft-ai-tests/server.log 2>/dev/null; then
              echo "âœ… Server ready!"
              break
            fi
            if [ $i -eq 120 ]; then
              echo "âŒ Server failed to start"
              cat ~/minecraft-ai-tests/server.log
              exit 1
            fi
            sleep 2
          done

      - name: Run AI-controlled test scenarios
        continue-on-error: true
        env:
          MC_HOST: localhost
          MC_PORT: 25565
          LLM_ENDPOINT: http://localhost:7424
          SCENARIO_ID: ${{ github.event.inputs.scenario || 'all' }}
          TEST_OUTPUT_DIR: ${{ github.workspace }}/ai-test-output
          GITHUB_SHA: ${{ github.sha }}
          BUILD_VERSION: ${{ github.run_number }}
        run: |
          echo "Running AI-controlled tests..."
          cd packages/ai-test-controller

          # Run tests with full AI control
          pnpm test:scenario localhost 25565 http://localhost:7424 "$SCENARIO_ID" "$TEST_OUTPUT_DIR"

      - name: Stop video recording
        if: always()
        run: |
          if [ -n "$RECORDER_PID" ]; then
            echo "Stopping video recorder..."
            kill $RECORDER_PID 2>/dev/null || true
            sleep 5
          fi

      - name: Stop profiling
        if: always()
        run: |
          if [ -n "$PROFILER_PID" ]; then
            echo "Stopping profiler..."
            kill $PROFILER_PID 2>/dev/null || true
          fi

      - name: Stop Minecraft server
        if: always()
        run: |
          if [ -n "$MC_SERVER_PID" ]; then
            echo "Stopping Minecraft server..."
            kill $MC_SERVER_PID 2>/dev/null || true
          fi

      - name: Stop FarmCraft servers
        if: always()
        run: |
          [ -n "$RECIPE_PID" ] && kill $RECIPE_PID 2>/dev/null || true
          [ -n "$LLM_PID" ] && kill $LLM_PID 2>/dev/null || true

      - name: Validate attestations
        if: always()
        run: |
          echo "Validating test attestations..."

          cd ai-test-output/attestations
          for attestation in *.json; do
            if [ -f "$attestation" ]; then
              echo "âœ… Found attestation: $attestation"
              HASH=$(jq -r '.sha256' "$attestation")
              echo "   SHA-256: $HASH"
              echo "   Commit: $(jq -r '.gitCommit' "$attestation")"
              echo "   Build: $(jq -r '.buildVersion' "$attestation")"
            fi
          done

      - name: Generate ML training manifest
        if: always()
        run: |
          echo "Generating ML training manifest..."

          cat > ai-test-output/ml-manifest.json << EOF
          {
            "build": {
              "commit": "${{ github.sha }}",
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}",
              "mod_hash": "${{ needs.build-with-attestation.outputs.mod-hash }}",
              "packages_hash": "${{ needs.build-with-attestation.outputs.packages-hash }}"
            },
            "test_run": {
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "platform": "macOS $(sw_vers -productVersion)",
              "architecture": "$(uname -m)",
              "scenario": "${{ github.event.inputs.scenario || 'all' }}"
            },
            "artifacts": {
              "videos": $(find ~/minecraft-ai-tests/videos -type f -name "*.mp4" | wc -l),
              "packets": $(find ai-test-output/packets -type f -name "*.json" | wc -l || echo 0),
              "attestations": $(find ai-test-output/attestations -type f -name "*.json" | wc -l || echo 0),
              "transcripts": $(find ai-test-output/transcripts -type f -name "*.txt" | wc -l || echo 0)
            }
          }
          EOF

          cat ai-test-output/ml-manifest.json

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-videos-${{ github.run_number }}
          path: ~/minecraft-ai-tests/videos/*.mp4
          retention-days: 90

      - name: Upload packet captures
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packet-captures-${{ github.run_number }}
          path: ai-test-output/packets/*.json
          retention-days: 90

      - name: Upload attestations
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-attestations-${{ github.run_number }}
          path: ai-test-output/attestations/*.json
          retention-days: 365

      - name: Upload transcripts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-transcripts-${{ github.run_number }}
          path: ai-test-output/transcripts/*.txt
          retention-days: 90

      - name: Upload ML manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-training-manifest-${{ github.run_number }}
          path: ai-test-output/ml-manifest.json
          retention-days: 365

      - name: Upload profiling data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: system-profiles-${{ github.run_number }}
          path: ~/minecraft-ai-tests/profiles/*.json
          retention-days: 90

      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs-${{ github.run_number }}
          path: |
            ~/minecraft-ai-tests/server.log
            ~/minecraft-ai-tests/logs/*.log
          retention-days: 30

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ¤– AI-Controlled Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${{ github.event.inputs.scenario || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** macOS M2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cryptographic Attestations" >> $GITHUB_STEP_SUMMARY
          echo "- **Mod JAR:** \`${{ needs.build-with-attestation.outputs.mod-hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages:** \`${{ needs.build-with-attestation.outputs.packages-hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ML Training Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Videos, packet captures, and attestations uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Full transcripts available for each test" >> $GITHUB_STEP_SUMMARY
          echo "- System profiling data included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All artifacts are cryptographically signed and ready for ML pipeline ingestion." >> $GITHUB_STEP_SUMMARY
